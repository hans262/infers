var o=class{constructor(t){if(t.find((r,i)=>t[i-1]&&r.length!==t[i-1].length))throw new Error("\u77E9\u9635\u5217\u4E0D\u6B63\u786E");this.shape=[t.length,t[0].length],this.self=t}slice(t,e){return new o(this.self.slice(t,e))}connect(t){if(this.shape[1]!==t.shape[1])throw new Error("\u5217\u6570\u4E0D\u7EDF\u4E00");let e=this.dataSync().concat(t.dataSync());return new o(e)}zeroed(){return this.atomicOperation(t=>0)}clone(){return new o(this.dataSync())}getMeanOfRow(t){let e=this.getRow(t);return e.reduce((r,i)=>r+i)/e.length}columnSum(){let t=[];for(let e=0;e<this.shape[1];e++)t.push(this.getCol(e).reduce((r,i)=>r+i));return new o([t])}dataSync(){let t=[];for(let e=0;e<this.shape[0];e++){let r=[];for(let i=0;i<this.shape[1];i++)r.push(this.get(e,i));t.push(r)}return t}equalsShape(t){return this.shape[0]===t.shape[0]&&this.shape[1]===t.shape[1]}equals(t){if(!this.equalsShape(t))return!1;for(let e=0;e<this.shape[0];e++)for(let r=0;r<this.shape[1];r++)if(this.get(e,r)!==t.get(e,r))return!1;return!0}static generate(t,e,r){let i=[];for(let s=0;s<t;s++){let a=[];for(let n=0;n<e;n++)a.push(r||.5-Math.random());i.push(a)}return new o(i)}update(t,e,r,i){switch(i){case"+=":this.self[t][e]+=r;break;case"-=":this.self[t][e]-=r;break;case"*=":this.self[t][e]*=r;break;case"/=":this.self[t][e]/=r;break;default:this.self[t][e]=r}}expand(t,e){let r=[];for(let i=0;i<this.shape[0];i++)e==="L"?r.push([t,...this.getRow(i)]):r.push([...this.getRow(i),t]);return new o(r)}get(t,e){return this.self[t][e]}getRow(t){return[...this.self[t]]}getCol(t){let e=[];for(let r=0;r<this.shape[0];r++)for(let i=0;i<this.shape[1];i++)i===t&&e.push(this.get(r,i));return e}det(){if(this.shape[0]!==this.shape[1])throw new Error("\u53EA\u6709\u65B9\u9635\u624D\u80FD\u8BA1\u7B97\u884C\u5217\u5F0F");if(this.shape[0]===2&&this.shape[1]===2)return this.get(0,0)*this.get(1,1)-this.get(0,1)*this.get(1,0);{let t=0;for(let e=0;e<this.shape[1];e++)this.get(0,e)!==0&&(t+=this.get(0,e)*(-1)**(e+2)*this.cominor(0,e).det());return t}}cominor(t,e){if(this.shape[0]<2||this.shape[1]<2)throw new Error("\u6C42\u4F59\u5B50\u5F0F\u884C\u548C\u5217\u5FC5\u987B\u5927\u4E8E2\u624D\u6709\u610F\u4E49");let r=this.dataSync().map(i=>(i=i.filter((s,a)=>a!==e),i)).filter((i,s)=>s!==t);return new o(r)}atomicOperation(t){let e=[];for(let r=0;r<this.shape[0];r++){let i=[];for(let s=0;s<this.shape[1];s++)i.push(t(this.get(r,s),r,s));e.push(i)}return new o(e)}coLocationOperation(t,e){if(!this.equalsShape(t))throw new Error("\u5FC5\u987B\u6EE1\u8DB3\u4E24\u4E2A\u77E9\u9635\u662F\u540C\u5F62\u77E9\u9635");let r=[];for(let i=0;i<this.shape[0];i++){let s=[];for(let a=0;a<this.shape[1];a++){let n=e==="add"?this.get(i,a)+t.get(i,a):this.get(i,a)-t.get(i,a);s.push(n)}r.push(s)}return new o(r)}subtraction(t){return this.coLocationOperation(t,"sub")}addition(t){return this.coLocationOperation(t,"add")}numberMultiply(t){return this.atomicOperation(e=>e*t)}multiply(t){if(this.shape[1]!==t.shape[0])throw new Error("\u5F53\u77E9\u9635A\u7684\u5217\u6570\u7B49\u4E8E\u77E9\u9635B\u7684\u884C\u6570\uFF0CA\u4E0EB\u624D\u53EF\u4EE5\u76F8\u4E58");let e=this.shape[0],r=t.shape[1],i=t.T,s=[];for(let a=0;a<e;a++){let n=[];for(let h=0;h<r;h++){let c=this.getRow(a).reduce((u,l,m)=>u+l*i.get(h,m),0);n.push(c)}s.push(n)}return new o(s)}get T(){let t=[];for(let e=0;e<this.shape[1];e++){let r=[];for(let i=0;i<this.shape[0];i++)r.push(this.get(i,e));t.push(r)}return new o(t)}normalization(){let t=this.T,e=[];for(let r=0;r<t.shape[0];r++){let i=Math.max(...t.getRow(r)),s=Math.min(...t.getRow(r)),a=i-s,n=s+a/2;e.push([n,a]);for(let h=0;h<t.shape[1];h++){let c=a===0?0:(t.get(r,h)-n)/a;t.update(r,h,c)}}return[t.T,new o(e).T]}print(){console.log(`Matrix ${this.shape[0]}x${this.shape[1]} [`);for(let t=0;t<this.shape[0];t++){let e=" ";for(let r=0;r<this.shape[1];r++)e+=this.get(t,r)+", ";console.log(e)}console.log("]")}};var d=class{constructor(t,e){this.X=t;this.Y=e}contrast(t){return this.X===t.X&&this.Y===t.Y}},E=class{constructor(t,e){if(this.start=new d(t[0],t[1]),this.end=new d(e[0],e[1]),this.start.contrast(this.end))throw new Error("\u4E24\u4E2A\u70B9\u4E0D\u80FD\u76F8\u540C")}minXY(){let t=Math.min(this.start.X,this.end.X),e=Math.min(this.start.Y,this.end.Y);return new d(t,e)}maxXY(){let t=Math.max(this.start.X,this.end.X),e=Math.max(this.start.Y,this.end.Y);return new d(t,e)}testPointIn(t){if(t.contrast(this.start)||t.contrast(this.end))return!0;let e=t.X-this.start.X==0?Infinity:(t.Y-this.start.Y)/(t.X-this.start.X),r=t.X-this.end.X==0?Infinity:(t.Y-this.end.Y)/(t.X-this.end.X);return e===r}testPointInside(t){if(this.testPointIn(t)){let e=this.minXY(),r=this.maxXY();return t.X>=e.X&&t.X<=r.X&&t.Y>=e.Y&&t.Y<=r.Y}return!1}},S=class{constructor(t){this.pts=t;if(t.length<2)throw new Error("\u81F3\u5C11\u4E24\u4E2A\u70B9");if(t.find((r,i)=>{let s=t[i+1];return s?r.contrast(s):!1}))throw new Error("\u4E0D\u80FD\u6709\u8FDE\u7EED\u91CD\u5408\u7684\u70B9")}},T=class{constructor(t){this.points=[];for(let n=0;n<t.length;n++)this.points.push(new d(t[n][0],t[n][1]));if(this.points.length<3)throw new Error("\u81F3\u5C11\u4E09\u4E2A\u70B9");let e=this.points.map(n=>n.X.toString()+n.Y.toString()).sort();if(e.find((n,h)=>n===e[h+1]))throw new Error("\u4E0D\u80FD\u6709\u76F8\u540C\u7684\u70B9");let i=this.points[0],a=this.points.slice(1).map(n=>n.X===i.X?Infinity:(n.Y-i.Y)/(n.X-i.X));if(new Set(a).size===1)throw new Error("\u6240\u6709\u70B9\u4E0D\u80FD\u5728\u4E00\u6761\u7EBF\u4E0A")}testPointInsidePolygon(t){let e=this.points;var r=0,i=e.length;if(i<3)return 0;for(var s=e[0],a=1;a<=i;++a){var n=a===i?e[0]:e[a];if(n.Y===t.Y&&(n.X===t.X||s.Y===t.Y&&n.X>t.X==s.X<t.X))return-1;if(s.Y<t.Y!=n.Y<t.Y){if(s.X>=t.X)if(n.X>t.X)r=1-r;else{var h=(s.X-t.X)*(n.Y-t.Y)-(n.X-t.X)*(s.Y-t.Y);if(h===0)return-1;h>0==n.Y>s.Y&&(r=1-r)}else if(n.X>t.X){var h=(s.X-t.X)*(n.Y-t.Y)-(n.X-t.X)*(s.Y-t.Y);if(h===0)return-1;h>0==n.Y>s.Y&&(r=1-r)}}s=n}return r}};function C(p,t){let e=10**t;return~~(p*e)/e}function M(p,t){let e=p.dataSync(),r=t.dataSync();for(let i=1;i<t.shape[0];i++){let s=Math.floor(Math.random()*(i+1));[e[i],e[s]]=[e[s],e[i]],[r[i],r[s]]=[r[s],r[i]]}return{xs:new o(e),ys:new o(r)}}var R=class{constructor(t,e){this.shape=t;this.mode="sgd";this.rate=.01;if(this.nlayer=t.length,this.nlayer<2)throw new Error("The network has at least two layers");this.w=[],this.b=[];for(let r=1;r<this.shape.length;r++)this.w[r]=o.generate(this.unit(r),this.unit(r-1)),this.b[r]=o.generate(1,this.unit(r));e&&(e.mode&&(this.mode=e.mode),e.rate&&(this.rate=e.rate),e.w&&(this.w=e.w),e.b&&(this.b=e.b),e.scalem&&(this.scalem=e.scalem))}unit(t){let e=this.shape[t];return Array.isArray(e)?e[0]:e}af(t){let e=this.shape[t];return Array.isArray(e)?e[1]:void 0}afn(t,e,r){switch(this.af(e)){case"Sigmoid":return 1/(1+Math.exp(-t));case"Relu":return t>=0?t:0;case"Tanh":return(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t));case"Softmax":let s=Math.max(...r);return Math.exp(t-s)/r.reduce((a,n)=>a+Math.exp(n-s),0);default:return t}}afd(t,e){switch(this.af(e)){case"Sigmoid":return t*(1-t);case"Relu":return t>=0?1:0;case"Tanh":return 1-((Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t)))**2;case"Softmax":default:return 1}}calcnet(t){let e=[];for(let r=0;r<this.nlayer;r++){if(r===0){e[r]=t;continue}let i=e[r-1].multiply(this.w[r].T).atomicOperation((s,a,n)=>s+this.b[r].get(0,n));e[r]=i.atomicOperation((s,a)=>this.afn(s,r,i.getRow(a)))}return e}zoomScalem(t){return t.atomicOperation((e,r,i)=>this.scalem?this.scalem.get(1,i)===0?0:(e-this.scalem.get(0,i))/this.scalem.get(1,i):e)}predict(t){if(t.shape[1]!==this.unit(0))throw new Error(`Input matrix column number error, input shape -> ${this.unit(0)}.`);return this.calcnet(this.zoomScalem(t))[this.nlayer-1]}calcDerivativeMul(t,e){let r=e.shape[0],i=null,s=null;for(let a=0;a<r;a++){let n=t.map(l=>new o([l.getRow(a)])),h=new o([e.getRow(a)]),{dw:c,dy:u}=this.calcDerivative(n,h);i=i?i.map((l,m)=>l.addition(c[m])):c,s=s?s.map((l,m)=>l.addition(u[m])):u}return i=i.map(a=>a.atomicOperation(n=>n/r)),s=s.map(a=>a.atomicOperation(n=>n/r)),{dy:s,dw:i}}calcDerivative(t,e){let r=this.w.map(s=>s.zeroed()),i=this.b.map(s=>s.zeroed());for(let s=this.nlayer-1;s>0;s--){if(s===this.nlayer-1){for(let a=0;a<this.unit(s);a++){i[s].update(0,a,(t[s].get(0,a)-e.get(0,a))*this.afd(t[s].get(0,a),s));for(let n=0;n<this.unit(s-1);n++)r[s].update(a,n,t[s-1].get(0,n)*i[s].get(0,a))}continue}for(let a=0;a<this.unit(s);a++){for(let n=0;n<this.unit(s+1);n++)i[s].update(0,a,i[s+1].get(0,n)*this.w[s+1].get(n,a),"+=");i[s].update(0,a,this.afd(t[s].get(0,a),s),"*=");for(let n=0;n<this.unit(s-1);n++)r[s].update(a,n,t[s-1].get(0,n)*i[s].get(0,a))}}return{dy:i,dw:r}}update(t,e){for(let r=1;r<this.nlayer;r++)this.w[r]=this.w[r].subtraction(e[r].numberMultiply(this.rate)),this.b[r]=this.b[r].subtraction(t[r].numberMultiply(this.rate))}cost(t,e){let r=e.shape[0],s=t.subtraction(e).atomicOperation(a=>a**2).columnSum().getRow(0).map(a=>a/(2*r));return s.reduce((a,n)=>a+n)/s.length}async bgd(t,e,r){for(let i=0;i<r.epochs;i++){let s=this.calcnet(t),{dy:a,dw:n}=this.calcDerivativeMul(s,e);this.update(a,n),r.onEpoch&&(r.onEpoch(i,this.cost(s[this.nlayer-1],e)),r.async&&await new Promise(h=>setTimeout(h))),r.onTrainEnd&&i===r.epochs-1&&r.onTrainEnd(this.cost(s[this.nlayer-1],e))}}async sgd(t,e,r){let i=e.shape[0];for(let s=0;s<r.epochs;s++){let a=null;for(let n=0;n<i;n++){let h=new o([t.getRow(n)]),c=new o([e.getRow(n)]),u=this.calcnet(h),{dy:l,dw:m}=this.calcDerivative(u,c);this.update(l,m),a=a?a.connect(u[this.nlayer-1]):u[this.nlayer-1]}r.onEpoch&&(r.onEpoch(s,this.cost(a,e)),r.async&&await new Promise(n=>setTimeout(n))),r.onTrainEnd&&s===r.epochs-1&&r.onTrainEnd(this.cost(a,e))}}async mbgd(t,e,r){let i=e.shape[0],s=r.batchSize?r.batchSize:10,a=Math.ceil(i/s);for(let n=0;n<r.epochs;n++){let{xs:h,ys:c}=M(t,e),u=0;for(let l=0;l<a;l++){let m=l*s,f=m+s;f=f>i?i:f;let x=f-m,y=h.slice(m,f),b=c.slice(m,f),w=this.calcnet(y),{dy:X,dw:Y}=this.calcDerivative(w,b);this.update(X,Y);let g=this.cost(w[this.nlayer-1],b);u+=g,r.onBatch&&r.onBatch(l,x,g)}r.onEpoch&&(r.onEpoch(n,u/a),r.async&&await new Promise(l=>setTimeout(l))),r.onTrainEnd&&n===r.epochs-1&&r.onTrainEnd(u/a)}}fit(t,e,r){if(t.shape[0]!==e.shape[0])throw new Error("The row number of input and output matrix is not uniform.");if(t.shape[1]!==this.unit(0))throw new Error(`Input matrix column number error, input shape -> ${this.unit(0)}.`);if(e.shape[1]!==this.unit(this.nlayer-1))throw new Error(`Output matrix column number error, output shape -> ${this.unit(this.nlayer-1)}.`);if(r.batchSize&&r.batchSize>e.shape[0])throw new Error("The batch size cannot be greater than the number of samples.");let[i,s]=t.normalization();switch(this.scalem=s,t=i,this.mode){case"bgd":return this.bgd(t,e,r);case"mbgd":return this.mbgd(t,e,r);case"sgd":default:return this.sgd(t,e,r)}}};export{R as BPNet,E as Edge,o as Matrix,S as Path,d as Point,T as Polygon,C as toFixed,M as upset};
