var l=class{constructor(t){if(t.find((r,i)=>t[i-1]&&r.length!==t[i-1].length))throw new Error("\u77E9\u9635\u5217\u4E0D\u6B63\u786E");this.shape=[t.length,t[0].length],this.self=t}slice(t,e){return new l(this.self.slice(t,e))}connect(t){if(this.shape[1]!==t.shape[1])throw new Error("\u5217\u6570\u4E0D\u7EDF\u4E00");let e=this.dataSync().concat(t.dataSync());return new l(e)}zeroed(){return this.atomicOperation(t=>0)}clone(){return new l(this.dataSync())}getMeanOfRow(t){let e=this.getRow(t);return e.reduce((r,i)=>r+i)/e.length}columnSum(){let t=[];for(let e=0;e<this.shape[1];e++)t.push(this.getCol(e).reduce((r,i)=>r+i));return new l([t])}dataSync(){let t=[];for(let e=0;e<this.shape[0];e++){let r=[];for(let i=0;i<this.shape[1];i++)r.push(this.get(e,i));t.push(r)}return t}equalsShape(t){return this.shape[0]===t.shape[0]&&this.shape[1]===t.shape[1]}equals(t){if(!this.equalsShape(t))return!1;for(let e=0;e<this.shape[0];e++)for(let r=0;r<this.shape[1];r++)if(this.get(e,r)!==t.get(e,r))return!1;return!0}static generate(t,e,r){let i=[];for(let a=0;a<t;a++){let n=[];for(let s=0;s<e;s++)n.push(typeof r=="number"?r:.5-Math.random());i.push(n)}return new l(i)}update(t,e,r,i){switch(i){case"+=":this.self[t][e]+=r;break;case"-=":this.self[t][e]-=r;break;case"*=":this.self[t][e]*=r;break;case"/=":this.self[t][e]/=r;break;default:this.self[t][e]=r}}expand(t,e){let r=[];for(let i=0;i<this.shape[0];i++)e==="L"?r.push([t,...this.getRow(i)]):r.push([...this.getRow(i),t]);return new l(r)}get(t,e){return this.self[t][e]}getRow(t){return[...this.self[t]]}getCol(t){let e=[];for(let r=0;r<this.shape[0];r++)for(let i=0;i<this.shape[1];i++)i===t&&e.push(this.get(r,i));return e}det(){if(this.shape[0]!==this.shape[1])throw new Error("\u53EA\u6709\u65B9\u9635\u624D\u80FD\u8BA1\u7B97\u884C\u5217\u5F0F");if(this.shape[0]===2&&this.shape[1]===2)return this.get(0,0)*this.get(1,1)-this.get(0,1)*this.get(1,0);{let t=0;for(let e=0;e<this.shape[1];e++)this.get(0,e)!==0&&(t+=this.get(0,e)*(-1)**(e+2)*this.cominor(0,e).det());return t}}cominor(t,e){if(this.shape[0]<2||this.shape[1]<2)throw new Error("\u6C42\u4F59\u5B50\u5F0F\u884C\u548C\u5217\u5FC5\u987B\u5927\u4E8E2\u624D\u6709\u610F\u4E49");let r=this.dataSync().map(i=>(i=i.filter((a,n)=>n!==e),i)).filter((i,a)=>a!==t);return new l(r)}atomicOperation(t){let e=[];for(let r=0;r<this.shape[0];r++){let i=[];for(let a=0;a<this.shape[1];a++)i.push(t(this.get(r,a),r,a));e.push(i)}return new l(e)}coLocationOperation(t,e){if(!this.equalsShape(t))throw new Error("\u5FC5\u987B\u6EE1\u8DB3\u4E24\u4E2A\u77E9\u9635\u662F\u540C\u5F62\u77E9\u9635");let r=[];for(let i=0;i<this.shape[0];i++){let a=[];for(let n=0;n<this.shape[1];n++){let s=e==="add"?this.get(i,n)+t.get(i,n):this.get(i,n)-t.get(i,n);a.push(s)}r.push(a)}return new l(r)}subtraction(t){return this.coLocationOperation(t,"sub")}addition(t){return this.coLocationOperation(t,"add")}numberMultiply(t){return this.atomicOperation(e=>e*t)}multiply(t){if(this.shape[1]!==t.shape[0])throw new Error("\u5F53\u77E9\u9635A\u7684\u5217\u6570\u7B49\u4E8E\u77E9\u9635B\u7684\u884C\u6570\uFF0CA\u4E0EB\u624D\u53EF\u4EE5\u76F8\u4E58");let e=this.shape[0],r=t.shape[1],i=t.T,a=[];for(let n=0;n<e;n++){let s=[];for(let o=0;o<r;o++){let h=this.getRow(n).reduce((u,c,m)=>u+c*i.get(o,m),0);s.push(h)}a.push(s)}return new l(a)}get T(){let t=[];for(let e=0;e<this.shape[1];e++){let r=[];for(let i=0;i<this.shape[0];i++)r.push(this.get(i,e));t.push(r)}return new l(t)}normalization(){let t=this.T,e=[];for(let r=0;r<t.shape[0];r++){let i=Math.max(...t.getRow(r)),a=Math.min(...t.getRow(r)),n=i-a,s=a+n/2;e.push([s,n]);for(let o=0;o<t.shape[1];o++){let h=n===0?0:(t.get(r,o)-s)/n;t.update(r,o,h)}}return[t.T,new l(e).T]}print(){console.log(`Matrix ${this.shape[0]}x${this.shape[1]} [`);for(let t=0;t<this.shape[0];t++){let e=" ";for(let r=0;r<this.shape[1];r++)e+=this.get(t,r)+", ";console.log(e)}console.log("]")}};var w=class{constructor(t,e){this.X=t;this.Y=e}contrast(t){return this.X===t.X&&this.Y===t.Y}},O=class{constructor(t,e){if(this.start=new w(t[0],t[1]),this.end=new w(e[0],e[1]),this.start.contrast(this.end))throw new Error("\u4E24\u4E2A\u70B9\u4E0D\u80FD\u76F8\u540C")}minXY(){let t=Math.min(this.start.X,this.end.X),e=Math.min(this.start.Y,this.end.Y);return new w(t,e)}maxXY(){let t=Math.max(this.start.X,this.end.X),e=Math.max(this.start.Y,this.end.Y);return new w(t,e)}testPointIn(t){if(t.contrast(this.start)||t.contrast(this.end))return!0;let e=t.X-this.start.X==0?Infinity:(t.Y-this.start.Y)/(t.X-this.start.X),r=t.X-this.end.X==0?Infinity:(t.Y-this.end.Y)/(t.X-this.end.X);return e===r}testPointInside(t){if(this.testPointIn(t)){let e=this.minXY(),r=this.maxXY();return t.X>=e.X&&t.X<=r.X&&t.Y>=e.Y&&t.Y<=r.Y}return!1}},P=class{constructor(t){this.pts=t;if(t.length<2)throw new Error("\u81F3\u5C11\u4E24\u4E2A\u70B9");if(t.find((r,i)=>{let a=t[i+1];return a?r.contrast(a):!1}))throw new Error("\u4E0D\u80FD\u6709\u8FDE\u7EED\u91CD\u5408\u7684\u70B9")}},E=class{constructor(t){this.points=[];for(let s=0;s<t.length;s++)this.points.push(new w(t[s][0],t[s][1]));if(this.points.length<3)throw new Error("\u81F3\u5C11\u4E09\u4E2A\u70B9");let e=this.points.map(s=>s.X.toString()+s.Y.toString()).sort();if(e.find((s,o)=>s===e[o+1]))throw new Error("\u4E0D\u80FD\u6709\u76F8\u540C\u7684\u70B9");let i=this.points[0],n=this.points.slice(1).map(s=>s.X===i.X?Infinity:(s.Y-i.Y)/(s.X-i.X));if(new Set(n).size===1)throw new Error("\u6240\u6709\u70B9\u4E0D\u80FD\u5728\u4E00\u6761\u7EBF\u4E0A")}testPointInsidePolygon(t){let e=this.points;var r=0,i=e.length;if(i<3)return 0;for(var a=e[0],n=1;n<=i;++n){var s=n===i?e[0]:e[n];if(s.Y===t.Y&&(s.X===t.X||a.Y===t.Y&&s.X>t.X==a.X<t.X))return-1;if(a.Y<t.Y!=s.Y<t.Y){if(a.X>=t.X)if(s.X>t.X)r=1-r;else{var o=(a.X-t.X)*(s.Y-t.Y)-(s.X-t.X)*(a.Y-t.Y);if(o===0)return-1;o>0==s.Y>a.Y&&(r=1-r)}else if(s.X>t.X){var o=(a.X-t.X)*(s.Y-t.Y)-(s.X-t.X)*(a.Y-t.Y);if(o===0)return-1;o>0==s.Y>a.Y&&(r=1-r)}}a=s}return r}};function W(d,t){let e=10**t;return~~(d*e)/e}function Y(d,t){let e=d.dataSync(),r=t.dataSync();for(let i=1;i<t.shape[0];i++){let a=Math.floor(Math.random()*(i+1));[e[i],e[a]]=[e[a],e[i]],[r[i],r[a]]=[r[a],r[i]]}return{xs:new l(e),ys:new l(r)}}var z=d=>({epochs:100,batchSize:d>10?10:d,async:!1}),S=class{constructor(t,e={}){this.shape=t;this.mode="sgd";this.rate=.01;if(this.hlayer=t.length-1,this.hlayer<1)throw new Error("The network has at least two layers");this.w=[],this.b=[];for(let r=0;r<this.hlayer;r++)this.w[r]=l.generate(this.unit(r),this.unit(r-1)),this.b[r]=l.generate(1,this.unit(r));e.mode&&(this.mode=e.mode),e.rate&&(this.rate=e.rate),e.w&&(this.w=e.w),e.b&&(this.b=e.b),e.scale&&(this.scale=e.scale)}unit(t){let e=this.shape[t+1];return Array.isArray(e)?e[0]:e}af(t){let e=this.shape[t+1];return Array.isArray(e)?e[1]:void 0}afn(t,e,r){switch(r){case"Sigmoid":return 1/(1+Math.exp(-t));case"Relu":return t>=0?t:0;case"Tanh":return(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t));case"Softmax":let i=Math.max(...e);return Math.exp(t-i)/e.reduce((a,n)=>a+Math.exp(n-i),0);default:return t}}afd(t,e){switch(e){case"Sigmoid":return t*(1-t);case"Relu":return t>=0?1:0;case"Tanh":return 1-((Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t)))**2;case"Softmax":default:return 1}}toJSON(){return JSON.stringify({mode:this.mode,shape:this.shape,rate:this.rate,scale:this.scale?this.scale.dataSync():void 0,w:this.w.map(t=>t.dataSync()),b:this.b.map(t=>t.dataSync())})}static fromJSON(t){let e=JSON.parse(t),r=e.w.map(n=>new l(n)),i=e.b.map(n=>new l(n)),a=e.scale?new l(e.scale):void 0;return new S(e.shape,{mode:e.mode,rate:e.mode,w:r,b:i,scale:a})}forwardPropagation(t){let e=[];for(let r=0;r<this.hlayer;r++){let i=r===0?t:e[r-1],a=this.af(r),n=i.multiply(this.w[r].T).atomicOperation((s,o,h)=>s+this.b[r].get(0,h));e[r]=n.atomicOperation((s,o)=>this.afn(s,n.getRow(o),a))}return e}scaled(t){return this.scale?t.atomicOperation((e,r,i)=>{let a=this.scale,n=a.get(1,i),s=a.get(0,i);return n===0?0:(e-s)/n}):t}predict(t){let e=this.predictNet(t);return e[e.length-1]}predictNet(t){this.checkInput(t),t=this.scaled(t);let e=this.forwardPropagation(t);return[t,...e]}backPropagationMultiple(t,e,r){let i=r.shape[0],a=this.w.map(h=>h.zeroed()),n=this.b.map(h=>h.zeroed());for(let h=0;h<i;h++){let u=t.map(f=>new l([f.getRow(h)])),c=new l([e.getRow(h)]),m=new l([r.getRow(h)]),{dw:p,dy:x}=this.backPropagation(u,c,m);a=a.map((f,g)=>f.addition(p[g])),n=n.map((f,g)=>f.addition(x[g]))}let s=a.map(h=>h.atomicOperation(u=>u/i));return{dy:n.map(h=>h.atomicOperation(u=>u/i)),dw:s}}backPropagation(t,e,r){let i=[],a=[];for(let n=this.hlayer-1;n>=0;n--){let s=t[n-1]?t[n-1]:e,o=this.af(n);n===this.hlayer-1?a[n]=t[n].atomicOperation((h,u,c)=>(h-r.get(u,c))*this.afd(h,o)):a[n]=a[n+1].multiply(this.w[n+1]).atomicOperation((h,u,c)=>h*this.afd(t[n].get(u,c),o)),i[n]=a[n].T.multiply(s)}return{dy:a,dw:i}}adjust(t,e){this.w=this.w.map((r,i)=>r.subtraction(e[i].numberMultiply(this.rate))),this.b=this.b.map((r,i)=>r.subtraction(t[i].numberMultiply(this.rate)))}cost(t,e){let r=e.shape[0],a=t.subtraction(e).atomicOperation(n=>n**2/2).columnSum().getRow(0).map(n=>n/r);return a.reduce((n,s)=>n+s)/a.length}calcLoss(t,e){this.checkSample(t,e);let r=this.predict(t);return this.cost(r,e)}async bgd(t,e,r){for(let i=0;i<r.epochs;i++){let a=this.forwardPropagation(t),{dy:n,dw:s}=this.backPropagationMultiple(a,t,e);this.adjust(n,s),r.onEpoch&&(r.onEpoch(i,this.cost(a[a.length-1],e)),r.async&&await new Promise(o=>setTimeout(o))),r.onTrainEnd&&i===r.epochs-1&&r.onTrainEnd(this.cost(a[a.length-1],e))}}async sgd(t,e,r){let i=e.shape[0];for(let a=0;a<r.epochs;a++){let n=null;for(let s=0;s<i;s++){let o=new l([t.getRow(s)]),h=new l([e.getRow(s)]),u=this.forwardPropagation(o),{dy:c,dw:m}=this.backPropagation(u,o,h);this.adjust(c,m),n=n?n.connect(u[u.length-1]):u[u.length-1]}r.onEpoch&&(r.onEpoch(a,this.cost(n,e)),r.async&&await new Promise(s=>setTimeout(s))),r.onTrainEnd&&a===r.epochs-1&&r.onTrainEnd(this.cost(n,e))}}async mbgd(t,e,r){let i=e.shape[0],a=r.batchSize,n=Math.ceil(i/a);for(let s=0;s<r.epochs;s++){let{xs:o,ys:h}=Y(t,e),u=0;for(let c=0;c<n;c++){let m=c*a,p=m+a;p=p>i?i:p;let x=p-m,f=o.slice(m,p),g=h.slice(m,p),b=this.forwardPropagation(f),M=b[b.length-1],{dy:y,dw:T}=this.backPropagationMultiple(b,f,g);this.adjust(y,T);let X=this.cost(M,g);u+=X,r.onBatch&&r.onBatch(c,x,X)}r.onEpoch&&(r.onEpoch(s,u/n),r.async&&await new Promise(c=>setTimeout(c))),r.onTrainEnd&&s===r.epochs-1&&r.onTrainEnd(u/n)}}checkInput(t){if(t.shape[1]!==this.unit(-1))throw new Error(`Input matrix column number error, input shape -> ${this.unit(-1)}.`)}checkOutput(t){if(t.shape[1]!==this.unit(this.hlayer-1))throw new Error(`Output matrix column number error, output shape -> ${this.unit(this.hlayer-1)}.`)}checkSample(t,e){if(t.shape[0]!==e.shape[0])throw new Error("The row number of input and output matrix is not uniform.");this.checkInput(t),this.checkOutput(e)}fit(t,e,r={}){let i=e.shape[0],a={...z(i),...r};if(this.checkSample(t,e),a.batchSize>i)throw new Error("The batch size cannot be greater than the number of samples.");let[n,s]=t.normalization();switch(this.scale=s,t=n,this.mode){case"bgd":return this.bgd(t,e,a);case"mbgd":return this.mbgd(t,e,a);case"sgd":default:return this.sgd(t,e,a)}}};var R=class{constructor(t){this.indexWord={};this.wordIndex={};this.hideSize=8;this.trainData=t.map(i=>i.split(""));let e=Array.from(new Set(this.trainData.flat(1)));for(let i=0;i<e.length;i++)this.indexWord[e[i]]=i,this.wordIndex[i]=e[i];this.inputSize=e.length,this.wordIndex[e.length]="/n",this.indexWord["/n"]=e.length;let r=this.inputSize+1;this.U=l.generate(this.hideSize,this.inputSize),this.W=l.generate(this.hideSize,this.hideSize),this.V=l.generate(r,this.hideSize)}afn(t,e,r){switch(r){case"Tanh":return(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t));case"Softmax":let i=Math.max(...e);return Math.exp(t-i)/e.reduce((a,n)=>a+Math.exp(n-i),0);default:return t}}afd(t,e){switch(e){case"Tanh":return 1-((Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t)))**2;case"Softmax":default:return 1}}oneHotXs(t){let e=l.generate(1,this.inputSize,0);return e.update(0,t,1),e}oneHotYs(t){let e=l.generate(1,this.inputSize+1,0);return t<0?e.update(0,this.inputSize,1):e.update(0,t,1),e}forwardPropagation(t){let e=l.generate(1,this.hideSize,0);return t.map(r=>{let{xs:i,ys:a}=r,n=i.multiply(this.U.T).addition(e.multiply(this.W.T));n=n.atomicOperation((h,u)=>this.afn(h,n.getRow(u),"Tanh"));let s=n.multiply(this.V.T);s=s.atomicOperation((h,u)=>this.afn(h,s.getRow(u),"Softmax"));let o=e;return e=n,{xs:i,ys:a,st:n,yt:s,lastSt:o}})}backPropagation(t){let e=this.V.zeroed(),r=this.U.zeroed(),i=this.W.zeroed();t.forEach(n=>{let{xs:s,ys:o,st:h,yt:u,lastSt:c}=n,m=u.atomicOperation((b,M,y)=>(b-o.get(M,y))*this.afd(b,"Softmax")),p=m.multiply(this.V);p=p.atomicOperation((b,M,y)=>b*this.afd(h.get(M,y),"Tanh"));let x=m.T.multiply(h),f=p.T.multiply(s),g=p.T.multiply(c);e=e.addition(x),r=r.addition(f),i=i.addition(g)});let a=.01;this.U=this.U.subtraction(r.numberMultiply(a)),this.W=this.W.subtraction(i.numberMultiply(a)),this.V=this.V.subtraction(e.numberMultiply(a))}predict(){let t="gou".split(""),e=this.onehot(t),r=this.forwardPropagation(e);console.log(this.showWords(r))}maxIndex(t){for(var e=t[0],r=0,i=0;i<t.length;i++)t[i]>e&&(e=t[i],r=i);return r}showWords(t){return t.map(e=>{let r=this.maxIndex(e.yt.getRow(0));if(!this.wordIndex[r])debugger;return this.wordIndex[r]})}cost(t){return t.map(r=>{let{yt:i,ys:a}=r,n=i.subtraction(a).atomicOperation(s=>s**2/2).getRow(0);return n.reduce((s,o)=>s+o)/n.length}).reduce((r,i)=>r+i)}onehot(t){return t.map((e,r)=>{let i=this.indexWord[e],a=t[r+1]?t[r+1]:"/n",n=this.indexWord[a],s=this.oneHotXs(i),o=this.oneHotYs(n);return{xs:s,ys:o}})}fit(){for(let t=0;t<5e3;t++){let e=0;for(let r=0;r<this.trainData.length;r++){let i=this.trainData[r],a=this.onehot(i),n=this.forwardPropagation(a);this.backPropagation(n),e+=this.cost(n)}t%100==0&&console.log("enpoch: ",t,"loss: ",e/this.trainData.length)}}};export{S as BPNet,O as Edge,l as Matrix,P as Path,w as Point,E as Polygon,R as RNN,z as defaultTrainingOptions,W as toFixed,Y as upset};
