var o=class{constructor(t){if(t.find((e,n)=>t[n-1]&&e.length!==t[n-1].length))throw new Error("\u77E9\u9635\u5217\u4E0D\u6B63\u786E");this.shape=[t.length,t[0].length],this.self=t}slice(t,r){return new o(this.self.slice(t,r))}connect(t){if(this.shape[1]!==t.shape[1])throw new Error("\u5217\u6570\u4E0D\u7EDF\u4E00");let r=this.dataSync().concat(t.dataSync());return new o(r)}zeroed(){return this.atomicOperation(t=>0)}clone(){return new o(this.dataSync())}getMeanOfRow(t){let r=this.getRow(t);return r.reduce((e,n)=>e+n)/r.length}columnSum(){let t=[];for(let r=0;r<this.shape[1];r++)t.push(this.getCol(r).reduce((e,n)=>e+n));return new o([t])}dataSync(){let t=[];for(let r=0;r<this.shape[0];r++){let e=[];for(let n=0;n<this.shape[1];n++)e.push(this.get(r,n));t.push(e)}return t}equalsShape(t){return this.shape[0]===t.shape[0]&&this.shape[1]===t.shape[1]}equals(t){if(!this.equalsShape(t))return!1;for(let r=0;r<this.shape[0];r++)for(let e=0;e<this.shape[1];e++)if(this.get(r,e)!==t.get(r,e))return!1;return!0}static generate(t,r,e){let n=[];for(let i=0;i<t;i++){let a=[];for(let s=0;s<r;s++)a.push(e||.5-Math.random());n.push(a)}return new o(n)}update(t,r,e,n){switch(n){case"+=":this.self[t][r]+=e;break;case"-=":this.self[t][r]-=e;break;case"*=":this.self[t][r]*=e;break;case"/=":this.self[t][r]/=e;break;default:this.self[t][r]=e}}expand(t,r){let e=[];for(let n=0;n<this.shape[0];n++)r==="L"?e.push([t,...this.getRow(n)]):e.push([...this.getRow(n),t]);return new o(e)}get(t,r){return this.self[t][r]}getRow(t){return[...this.self[t]]}getCol(t){let r=[];for(let e=0;e<this.shape[0];e++)for(let n=0;n<this.shape[1];n++)n===t&&r.push(this.get(e,n));return r}det(){if(this.shape[0]!==this.shape[1])throw new Error("\u53EA\u6709\u65B9\u9635\u624D\u80FD\u8BA1\u7B97\u884C\u5217\u5F0F");if(this.shape[0]===2&&this.shape[1]===2)return this.get(0,0)*this.get(1,1)-this.get(0,1)*this.get(1,0);{let t=0;for(let r=0;r<this.shape[1];r++)this.get(0,r)!==0&&(t+=this.get(0,r)*(-1)**(r+2)*this.cominor(0,r).det());return t}}cominor(t,r){if(this.shape[0]<2||this.shape[1]<2)throw new Error("\u6C42\u4F59\u5B50\u5F0F\u884C\u548C\u5217\u5FC5\u987B\u5927\u4E8E2\u624D\u6709\u610F\u4E49");let e=this.dataSync().map(n=>(n=n.filter((i,a)=>a!==r),n)).filter((n,i)=>i!==t);return new o(e)}atomicOperation(t){let r=[];for(let e=0;e<this.shape[0];e++){let n=[];for(let i=0;i<this.shape[1];i++)n.push(t(this.get(e,i),e,i));r.push(n)}return new o(r)}coLocationOperation(t,r){if(!this.equalsShape(t))throw new Error("\u5FC5\u987B\u6EE1\u8DB3\u4E24\u4E2A\u77E9\u9635\u662F\u540C\u5F62\u77E9\u9635");let e=[];for(let n=0;n<this.shape[0];n++){let i=[];for(let a=0;a<this.shape[1];a++){let s=r==="add"?this.get(n,a)+t.get(n,a):this.get(n,a)-t.get(n,a);i.push(s)}e.push(i)}return new o(e)}subtraction(t){return this.coLocationOperation(t,"sub")}addition(t){return this.coLocationOperation(t,"add")}numberMultiply(t){return this.atomicOperation(r=>r*t)}multiply(t){if(this.shape[1]!==t.shape[0])throw new Error("\u5F53\u77E9\u9635A\u7684\u5217\u6570\u7B49\u4E8E\u77E9\u9635B\u7684\u884C\u6570\uFF0CA\u4E0EB\u624D\u53EF\u4EE5\u76F8\u4E58");let r=this.shape[0],e=t.shape[1],n=t.T,i=[];for(let a=0;a<r;a++){let s=[];for(let h=0;h<e;h++){let c=this.getRow(a).reduce((u,l,m)=>u+l*n.get(h,m),0);s.push(c)}i.push(s)}return new o(i)}get T(){let t=[];for(let r=0;r<this.shape[1];r++){let e=[];for(let n=0;n<this.shape[0];n++)e.push(this.get(n,r));t.push(e)}return new o(t)}normalization(){let t=this.T,r=[];for(let e=0;e<t.shape[0];e++){let n=Math.max(...t.getRow(e)),i=Math.min(...t.getRow(e)),a=n-i,s=i+a/2;r.push([s,a]);for(let h=0;h<t.shape[1];h++){let c=a===0?0:(t.get(e,h)-s)/a;t.update(e,h,c)}}return[t.T,new o(r).T]}print(){console.log(`Matrix ${this.shape[0]}x${this.shape[1]} [`);for(let t=0;t<this.shape[0];t++){let r=" ";for(let e=0;e<this.shape[1];e++)r+=this.get(t,e)+", ";console.log(r)}console.log("]")}};var d=class{constructor(t,r){this.X=t;this.Y=r}contrast(t){return this.X===t.X&&this.Y===t.Y}},E=class{constructor(t,r){if(this.start=new d(t[0],t[1]),this.end=new d(r[0],r[1]),this.start.contrast(this.end))throw new Error("\u4E24\u4E2A\u70B9\u4E0D\u80FD\u76F8\u540C")}minXY(){let t=Math.min(this.start.X,this.end.X),r=Math.min(this.start.Y,this.end.Y);return new d(t,r)}maxXY(){let t=Math.max(this.start.X,this.end.X),r=Math.max(this.start.Y,this.end.Y);return new d(t,r)}testPointIn(t){if(t.contrast(this.start)||t.contrast(this.end))return!0;let r=t.X-this.start.X==0?Infinity:(t.Y-this.start.Y)/(t.X-this.start.X),e=t.X-this.end.X==0?Infinity:(t.Y-this.end.Y)/(t.X-this.end.X);return r===e}testPointInside(t){if(this.testPointIn(t)){let r=this.minXY(),e=this.maxXY();return t.X>=r.X&&t.X<=e.X&&t.Y>=r.Y&&t.Y<=e.Y}return!1}},S=class{constructor(t){this.pts=t;if(t.length<2)throw new Error("\u81F3\u5C11\u4E24\u4E2A\u70B9");if(t.find((e,n)=>{let i=t[n+1];return i?e.contrast(i):!1}))throw new Error("\u4E0D\u80FD\u6709\u8FDE\u7EED\u91CD\u5408\u7684\u70B9")}},T=class{constructor(t){this.points=[];for(let s=0;s<t.length;s++)this.points.push(new d(t[s][0],t[s][1]));if(this.points.length<3)throw new Error("\u81F3\u5C11\u4E09\u4E2A\u70B9");let r=this.points.map(s=>s.X.toString()+s.Y.toString()).sort();if(r.find((s,h)=>s===r[h+1]))throw new Error("\u4E0D\u80FD\u6709\u76F8\u540C\u7684\u70B9");let n=this.points[0],a=this.points.slice(1).map(s=>s.X===n.X?Infinity:(s.Y-n.Y)/(s.X-n.X));if(new Set(a).size===1)throw new Error("\u6240\u6709\u70B9\u4E0D\u80FD\u5728\u4E00\u6761\u7EBF\u4E0A")}testPointInsidePolygon(t){let r=this.points;var e=0,n=r.length;if(n<3)return 0;for(var i=r[0],a=1;a<=n;++a){var s=a===n?r[0]:r[a];if(s.Y===t.Y&&(s.X===t.X||i.Y===t.Y&&s.X>t.X==i.X<t.X))return-1;if(i.Y<t.Y!=s.Y<t.Y){if(i.X>=t.X)if(s.X>t.X)e=1-e;else{var h=(i.X-t.X)*(s.Y-t.Y)-(s.X-t.X)*(i.Y-t.Y);if(h===0)return-1;h>0==s.Y>i.Y&&(e=1-e)}else if(s.X>t.X){var h=(i.X-t.X)*(s.Y-t.Y)-(s.X-t.X)*(i.Y-t.Y);if(h===0)return-1;h>0==s.Y>i.Y&&(e=1-e)}}i=s}return e}};function C(p,t){let r=10**t;return~~(p*r)/r}function M(p,t){let r=p.dataSync(),e=t.dataSync();for(let n=1;n<t.shape[0];n++){let i=Math.floor(Math.random()*(n+1));[r[n],r[i]]=[r[i],r[n]],[e[n],e[i]]=[e[i],e[n]]}return{xs:new o(r),ys:new o(e)}}var v=class{constructor(t,r){this.shape=t;this.mode="sgd";this.rate=.01;if(this.nlayer=t.length,this.nlayer<2)throw new Error("The network has at least two layers");this.w=[],this.b=[];for(let e=1;e<this.shape.length;e++)this.w[e]=o.generate(this.unit(e),this.unit(e-1)),this.b[e]=o.generate(1,this.unit(e));r&&(r.mode&&(this.mode=r.mode),r.rate&&(this.rate=r.rate),r.w&&(this.w=r.w),r.b&&(this.b=r.b),r.scale&&(this.scale=r.scale))}unit(t){let r=this.shape[t];return Array.isArray(r)?r[0]:r}af(t){let r=this.shape[t];return Array.isArray(r)?r[1]:void 0}afn(t,r,e){switch(this.af(r)){case"Sigmoid":return 1/(1+Math.exp(-t));case"Relu":return t>=0?t:0;case"Tanh":return(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t));case"Softmax":let i=Math.max(...e);return Math.exp(t-i)/e.reduce((a,s)=>a+Math.exp(s-i),0);default:return t}}afd(t,r){switch(this.af(r)){case"Sigmoid":return t*(1-t);case"Relu":return t>=0?1:0;case"Tanh":return 1-((Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t)))**2;case"Softmax":default:return 1}}calcnet(t){let r=[];for(let e=0;e<this.nlayer;e++){if(e===0){r[e]=t;continue}let n=r[e-1].multiply(this.w[e].T).atomicOperation((i,a,s)=>i+this.b[e].get(0,s));r[e]=n.atomicOperation((i,a)=>this.afn(i,e,n.getRow(a)))}return r}scaled(t){return this.scale?t.atomicOperation((r,e,n)=>{let i=this.scale,a=i.get(1,n),s=i.get(0,n);return a===0?0:(r-s)/a}):t}predict(t){if(t.shape[1]!==this.unit(0))throw new Error(`Input matrix column number error, input shape -> ${this.unit(0)}.`);return this.calcnet(this.scaled(t))[this.nlayer-1]}calcDerivativeMul(t,r){let e=r.shape[0],n=null,i=null;for(let a=0;a<e;a++){let s=t.map(l=>new o([l.getRow(a)])),h=new o([r.getRow(a)]),{dw:c,dy:u}=this.calcDerivative(s,h);n=n?n.map((l,m)=>l.addition(c[m])):c,i=i?i.map((l,m)=>l.addition(u[m])):u}return n=n.map(a=>a.atomicOperation(s=>s/e)),i=i.map(a=>a.atomicOperation(s=>s/e)),{dy:i,dw:n}}calcDerivative(t,r){let e=this.w.map(i=>i.zeroed()),n=this.b.map(i=>i.zeroed());for(let i=this.nlayer-1;i>0;i--){if(i===this.nlayer-1){for(let a=0;a<this.unit(i);a++){n[i].update(0,a,(t[i].get(0,a)-r.get(0,a))*this.afd(t[i].get(0,a),i));for(let s=0;s<this.unit(i-1);s++)e[i].update(a,s,t[i-1].get(0,s)*n[i].get(0,a))}continue}for(let a=0;a<this.unit(i);a++){for(let s=0;s<this.unit(i+1);s++)n[i].update(0,a,n[i+1].get(0,s)*this.w[i+1].get(s,a),"+=");n[i].update(0,a,this.afd(t[i].get(0,a),i),"*=");for(let s=0;s<this.unit(i-1);s++)e[i].update(a,s,t[i-1].get(0,s)*n[i].get(0,a))}}return{dy:n,dw:e}}update(t,r){for(let e=1;e<this.nlayer;e++)this.w[e]=this.w[e].subtraction(r[e].numberMultiply(this.rate)),this.b[e]=this.b[e].subtraction(t[e].numberMultiply(this.rate))}cost(t,r){let e=r.shape[0],i=t.subtraction(r).atomicOperation(a=>a**2).columnSum().getRow(0).map(a=>a/(2*e));return i.reduce((a,s)=>a+s)/i.length}async bgd(t,r,e){for(let n=0;n<e.epochs;n++){let i=this.calcnet(t),{dy:a,dw:s}=this.calcDerivativeMul(i,r);this.update(a,s),e.onEpoch&&(e.onEpoch(n,this.cost(i[this.nlayer-1],r)),e.async&&await new Promise(h=>setTimeout(h))),e.onTrainEnd&&n===e.epochs-1&&e.onTrainEnd(this.cost(i[this.nlayer-1],r))}}async sgd(t,r,e){let n=r.shape[0];for(let i=0;i<e.epochs;i++){let a=null;for(let s=0;s<n;s++){let h=new o([t.getRow(s)]),c=new o([r.getRow(s)]),u=this.calcnet(h),{dy:l,dw:m}=this.calcDerivative(u,c);this.update(l,m),a=a?a.connect(u[this.nlayer-1]):u[this.nlayer-1]}e.onEpoch&&(e.onEpoch(i,this.cost(a,r)),e.async&&await new Promise(s=>setTimeout(s))),e.onTrainEnd&&i===e.epochs-1&&e.onTrainEnd(this.cost(a,r))}}async mbgd(t,r,e){let n=r.shape[0],i=e.batchSize?e.batchSize:10,a=Math.ceil(n/i);for(let s=0;s<e.epochs;s++){let{xs:h,ys:c}=M(t,r),u=0;for(let l=0;l<a;l++){let m=l*i,f=m+i;f=f>n?n:f;let x=f-m,y=h.slice(m,f),b=c.slice(m,f),w=this.calcnet(y),{dy:X,dw:Y}=this.calcDerivative(w,b);this.update(X,Y);let g=this.cost(w[this.nlayer-1],b);u+=g,e.onBatch&&e.onBatch(l,x,g)}e.onEpoch&&(e.onEpoch(s,u/a),e.async&&await new Promise(l=>setTimeout(l))),e.onTrainEnd&&s===e.epochs-1&&e.onTrainEnd(u/a)}}fit(t,r,e){if(t.shape[0]!==r.shape[0])throw new Error("The row number of input and output matrix is not uniform.");if(t.shape[1]!==this.unit(0))throw new Error(`Input matrix column number error, input shape -> ${this.unit(0)}.`);if(r.shape[1]!==this.unit(this.nlayer-1))throw new Error(`Output matrix column number error, output shape -> ${this.unit(this.nlayer-1)}.`);if(e.batchSize&&e.batchSize>r.shape[0])throw new Error("The batch size cannot be greater than the number of samples.");let[n,i]=t.normalization();switch(this.scale=i,t=n,this.mode){case"bgd":return this.bgd(t,r,e);case"mbgd":return this.mbgd(t,r,e);case"sgd":default:return this.sgd(t,r,e)}}};export{v as BPNet,E as Edge,o as Matrix,S as Path,d as Point,T as Polygon,C as toFixed,M as upset};
